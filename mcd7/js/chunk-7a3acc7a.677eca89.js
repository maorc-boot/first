(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7a3acc7a"],{"113b":function(e,t,i){"use strict";i("9cf7")},2283:function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e._self._c;return t("div",{staticClass:"scene"},[t("header",[t("div",{staticClass:"customer"},[t("span",[t("span",[e._v(e._s(e.isFission?e.title:e.form.sceneName)+"：")]),null!==e.form.customerNum?t("span",[e._v(" "+e._s(e.form.customerNum)+"人"+e._s(e.customerNumRate)+" ")]):e._e()]),e.calcLoading?t("span",{staticClass:"tip"},[t("i",{staticClass:"el-icon-loading"}),e._v("计算中")]):e._e(),e.calcLoading||e.calcResult?e._e():t("span",{staticClass:"tip-error"},[t("i",{staticClass:"el-icon-warning-outline"}),e._v("客群计算失败 ")]),e.aiHelp&&!e.calcLoading&&e.form.customerNum&&!e.form.finalExpression?t("span",{staticClass:"tip-error"},[t("i",{staticClass:"el-icon-warning-outline"}),e._v("不支持该客群范围 ")]):e._e()]),t("div",[e.aiHelp&&e.form.customerNum>0?t("el-button",{attrs:{size:"mini",type:"success",plain:""},on:{click:e.openOptimizeDialog}},[e._v(" AI瘦身 ")]):e._e(),e.isFission?t("el-button",{attrs:{type:"text",size:"medium"},on:{click:e.remove}},[e._v(" "+e._s(e.aiHelp?"删除客群规则":"删除场景")+" ")]):e._e()],1)]),t("div",{staticClass:"scene__container"},[t("el-form",{ref:"formRef",attrs:{"label-width":e.labelWidth,"label-suffix":"：",model:e.form,rules:e.rules}},[e._e(),e.aiHelp?e._e():t("el-form-item",{attrs:{label:"场景名称",prop:"sceneName"}},[t("el-input",{attrs:{maxlength:25,placeholder:"请输入场景名称","show-word-limit":""},model:{value:e.form.sceneName,callback:function(t){e.$set(e.form,"sceneName",t)},expression:"form.sceneName"}})],1),"2"==e.form.attrType?t("el-form-item",{attrs:{label:"基础客群",prop:"customerGroupId"}},[t("el-select",{staticStyle:{width:"400px"},attrs:{filterable:"",placeholder:"请选择基础客群"},on:{change:e.changeBaseCustomer},model:{value:e.form.customerGroupId,callback:function(t){e.$set(e.form,"customerGroupId",t)},expression:"form.customerGroupId"}},e._l(e.form.selectCustomerList,(function(e){return t("el-option",{key:e.customGroupId,attrs:{label:e.customGroupName,value:e.customGroupId}})})),1)],1):e._e(),t("el-form-item",{attrs:{label:e.aiHelp?"客群范围":"场景条件",prop:"validateC"}},e._l(e.conditions,(function(i,n){return t("div",{key:i.id+n,staticClass:"c-branch"},[t("el-select",{staticStyle:{width:"150px"},attrs:{filterable:"",placeholder:"请选择标签"},on:{change:function(t){return e.onColumnChange(t,n)}},model:{value:e.conditions[n].columnNum,callback:function(t){e.$set(e.conditions[n],"columnNum",t)},expression:"conditions[index].columnNum"}},e._l(e.selectedColumns,(function(e){return t("el-option",{key:e.columnNum,attrs:{label:e.columnName,value:e.columnNum}})})),1),2!=e.conditions[n].valueType?[t("el-select",{staticStyle:{width:"100px"},attrs:{placeholder:"计算方式"},model:{value:e.conditions[n].calType,callback:function(t){e.$set(e.conditions[n],"calType",t)},expression:"conditions[index].calType"}},e._l(e.conditionList,(function(e){return t("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1),t("el-select",{staticClass:"tags-select-input",staticStyle:{width:"200px"},attrs:{"value-key":"value","collapse-tags":"",multiple:"",filterable:""},model:{value:e.conditions[n].selectedValues,callback:function(t){e.$set(e.conditions[n],"selectedValues",t)},expression:"conditions[index].selectedValues"}},e._l(i.valueList,(function(e){return t("el-option",{key:e.id,attrs:{label:e.label,value:e.value}})})),1)]:[t("el-select",{staticStyle:{width:"100px"},attrs:{placeholder:"计算方式"},on:{change:function(t){return e.changeCalType(t,n)}},model:{value:e.conditions[n].calType,callback:function(t){e.$set(e.conditions[n],"calType",t)},expression:"conditions[index].calType"}},e._l(e.conditionListNum,(function(e){return t("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1),e.between.includes(e.conditions[n].calType)?[t("el-input-number",{staticStyle:{width:"87px"},model:{value:e.conditions[n].numVal1,callback:function(t){e.$set(e.conditions[n],"numVal1",t)},expression:"conditions[index].numVal1"}}),t("span",[e._v("-")]),t("el-input-number",{staticStyle:{width:"87px"},model:{value:e.conditions[n].numVal2,callback:function(t){e.$set(e.conditions[n],"numVal2",t)},expression:"conditions[index].numVal2"}})]:t("el-input-number",{staticStyle:{width:"200px"},model:{value:e.conditions[n].value,callback:function(t){e.$set(e.conditions[n],"value",t)},expression:"conditions[index].value"}})],t("i",{directives:[{name:"show",rawName:"v-show",value:0!==n,expression:"index !== 0"}],staticClass:"el-icon-remove-outline icon",on:{click:function(t){return e.removeCondition(n)}}}),n==e.conditions.length-1?t("div",{staticClass:"branch__add",on:{click:e.addCondition}},[t("i",{staticClass:"el-icon-circle-plus-outline icon"})]):e._e()],2)})),0)],1)],1),t("LabelOptimizeDialog",{ref:"optimizeRef",on:{save:e.changeRule}})],1)},s=[],o=(i("14d9"),i("0fea")),l=i("afd9"),a=i("82be"),c=i("bdad"),u={components:{LabelOptimizeDialog:()=>i.e("chunk-ef31e722").then(i.bind(null,"cdae"))},props:{childIndex:{type:Number,default:0},aiHelp:{type:Boolean,default:!1},title:{type:String,default:""},labelWidth:{type:String,default:"120px"},selectedColumns:{type:Array,default:()=>[]},echoData:{type:Object,default:()=>{}},node:{type:Object,default:()=>({})},isFission:{type:Boolean,default:!0}},computed:{customerNumRate(){if(this.aiHelp)return null;let e;e=this.isFission?this.node:$graph.findDataById(this.node.pId);const t=e.businessData.customerNum;return t?" | "+((this.form.customerNum||0)/t*100).toFixed(2)+"% 占比":null}},data(){return{form:{sceneId:"",sceneName:"",attrType:"0",selectCustomerList:[],customerGroupId:void 0,customerInfo:{},selectAttrList:[],selectAttrStr:"",customerNum:null,finalExpression:null,conditionDesc:"",conditionParams:[],conditions:[],validateC:null},conditions:[{id:Object(c["c"])(),type:"",columnNum:null,columnName:null,valueType:null,calType:null,conditionValue:null,valueList:[],selectedValues:[],value:void 0,numVal1:void 0,numVal2:void 0,conditionDesc:""}],conditionList:a["a"],between:["()","(]","[)","[]"],conditionListNum:a["b"],rules:{customerGroupId:[{required:!0,message:"请选择基础客群",trigger:"change"}],sceneName:[{required:!0,message:"请输入场景名称",trigger:"blur"}],validateC:[{required:!0,message:"请填写规则条件",trigger:"blur"}]},ancestorConditions:[],source:null,calcLoading:!1,calcResult:!0,isNeedCalc:!0}},watch:{conditions:{handler(e){if(!this.isNeedCalc)return;let t=this.validateCondition();if(!t)return this.form.customerNum=null,this.form.finalExpression=null,void(this.calcLoading&&(this.source.cancel("取消未完成的请求"),this.calcLoading=!1));this.$refs.formRef.clearValidate("validateC"),this.calcSceneCount()},deep:!0}},methods:{echoForm(){const{conditions:e}=this.echoData;null!==e&&void 0!==e&&e.length&&(this.conditions=JSON.parse(JSON.stringify(e))),this.echoData.sceneId&&(this.form=this.echoData),this.$delete(this.form,"conditions"),this.isNeedCalc=!1,this.$nextTick(()=>{this.isNeedCalc=!0})},changeBaseCustomer(e){const t=this.form.selectCustomerList.find(t=>t.customGroupId===e);this.form.customerInfo=t;const i=this.validateCondition();i&&this.calcSceneCount()},onColumnChange(e,t){var i;this.$set(this.conditions[t],"calType",null),this.$set(this.conditions[t],"value",void 0),this.$set(this.conditions[t],"numVal1",void 0),this.$set(this.conditions[t],"numVal2",void 0),this.$set(this.conditions[t],"selectedValues",[]),this.$set(this.conditions[t],"valueList",[]);const n=this.selectedColumns.find(t=>t.columnNum===e);if(this.$set(this.conditions[t],"columnName",n.columnName),this.$set(this.conditions[t],"valueType",n.valueType),null===(i=n.valueList)||void 0===i||!i.length)return;let s=n.valueList.map(e=>({...e,label:Object(a["c"])(e)}));this.$set(this.conditions[t],"valueList",s)},changeCalType(e,t){this.between.includes(e)?this.$set(this.conditions[t],"value",void 0):(this.$set(this.conditions[t],"numVal1",void 0),this.$set(this.conditions[t],"numVal2",void 0))},addCondition(){this.conditions.push({id:Object(c["c"])(),type:"",columnNum:null,columnName:null,valueType:null,calType:null,conditionValue:null,valueList:[],selectedValues:[],value:void 0,numVal1:void 0,numVal2:void 0,conditionDesc:""})},getConditionDesc(){this.conditions.forEach(e=>{var t;let i,n=null===(t=this.selectedColumns.find(t=>t.columnNum===e.columnNum))||void 0===t?void 0:t.columnName,s="";var o,l;2!=e.valueType?(i=null===(o=this.conditionList.find(t=>t.value===e.calType))||void 0===o?void 0:o.label,e.selectedValues.forEach((t,i)=>{var n;let o=null===(n=e.valueList.find(e=>e.value===t))||void 0===n?void 0:n.label;s+=i>0?"，"+o:o}),s=`【${s}】`):(i=null===(l=this.conditionListNum.find(t=>t.value===e.calType))||void 0===l?void 0:l.label,i.includes("介于")?(i="介于",s=`${e.numVal1} - ${e.numVal2}`):s=e.value);let a=n+" "+i+s;this.$set(e,"conditionDesc",a)}),this.form.conditionDesc=this.conditions.map(e=>e.conditionDesc).join(" & ")},removeCondition(e){this.conditions.splice(e,1)},validateCondition(){let e=!0;for(let t=0;t<this.conditions.length;t++){let i=this.conditions[t];if(null===i.columnNum||null===i.calType){e=null;break}if(1==i.valueType&&!i.selectedValues.length){e=null;break}if(2==i.valueType)if(this.between.includes(i.calType)){let t="number"===typeof i.numVal1,n="number"===typeof i.numVal2;if(!t||!n){e=null;break}}else if("number"!==typeof i.value){e=null;break}}return e},validate(){let e=this.validateCondition();return this.form.validateC=e,this.getConditionDesc(),new Promise((e,t)=>{this.$refs.formRef.validate(i=>{if(this.calcLoading)return this.$message({message:"请等待客群数量计算完成！",type:"warning",duration:3e3}),t(!1);if(i){if(!this.form.customerNum)return this.$message({message:"客群数量不能等于0！请重新选择条件",type:"error"}),t({type:"scroll",childIndex:this.childIndex});e({...this.form,conditions:this.conditions})}else t({type:"scroll",childIndex:this.childIndex})})})},remove(){this.$emit("remove")},assembleParams(){var e;let t=[];const i=(null===(e=this.node)||void 0===e||null===(e=e.nodeLines)||void 0===e?void 0:e.filter(e=>"Scene"===e.nodeType))||[];this.isFission||i.pop(),i.forEach(e=>{const i=$graph.findDataById(e.nodeId);t=t.concat(i.businessData.conditions||[])});const n=[...t,...this.conditions],s=Object(a["e"])(n,this.form);return this.form.conditionParams=Object(a["f"])(n,this.form),s},async calcSceneCount(){const e=this.assembleParams();this.calcLoading&&this.source.cancel("取消未完成的请求"),this.source=this.$CancelToken.source();try{this.form.customerNum=null,this.form.finalExpression=null,this.calcLoading=!0;const{count:t,finalExpression:i}=await Object(o["i"])(l["a"].getTargetUserCount,e,this.source.token,12e4);this.form.customerNum=t,this.form.finalExpression=i,this.aiHelp&&!i&&(this.form.customerNum=null,this.form.finalExpression=null),this.form.validateC=!0,this.calcLoading=!1,this.calcResult=!0}catch(t){if("取消未完成的请求"===t.message)return;this.calcLoading=!1,this.calcResult=!1}},openOptimizeDialog(){var e;this.getConditionDesc();const t=null===(e=this.node.nodeLines.find(e=>"Product"===e.nodeType))||void 0===e?void 0:e.nodeId,i=$graph.findDataById(t),n=i.businessData.productList[0].planId,s={conditionList:this.conditions,form:this.form,planId:n,custColumnNum:this.form.customerInfo.columnNum||null};this.$refs.optimizeRef.open(JSON.parse(JSON.stringify(s)))},changeRule(e){const{conditionList:t,customerNum:i,finalExpression:n}=e;this.form.customerNum=i,this.form.finalExpression=n,this.conditions.splice(0,this.conditions.length),t.forEach(e=>{e.id=Object(c["c"])(),this.selectedColumns.some(t=>t.columnNum===e.columnNum)||this.selectedColumns.push({id:e.id,columnNum:e.columnNum,columnName:e.columnName,valueType:e.valueType,valueList:e.valueList}),this.conditions.push(e)}),this.isNeedCalc=!1,this.$nextTick(()=>{this.isNeedCalc=!0})}},created(){this.echoForm()}},d=u,r=(i("113b"),i("2877")),m=Object(r["a"])(d,n,s,!1,null,"baa1964e",null);t["default"]=m.exports},"9cf7":function(e,t,i){}}]);