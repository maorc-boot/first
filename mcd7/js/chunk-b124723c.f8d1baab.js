(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-b124723c"],{"00d8":function(e,t,r){"use strict";r.r(t);var s=function(){var e=this,t=e._self._c;return t("div",{directives:[{name:"loading",rawName:"v-loading",value:e.ruleLoading,expression:"ruleLoading"}],staticClass:"scene-layout",attrs:{"element-loading-text":"规则计算中","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(255, 255, 255, .8)"}},["1"!=e.form.attrType?t("SelectView",{attrs:{title:"已选标签",option:{label:"columnName",value:"columnNum"},list:e.form.selectAttrList}}):e._e(),2==e.form.attrType?t("div",{staticStyle:{height:"2px"}}):e._e(),"0"!=e.form.attrType?t("SelectView",{attrs:{title:"已选客群",option:{label:"customGroupName",value:"customGroupId"},list:e.form.selectCustomerList}}):e._e(),t("el-form",{ref:"outFormRef",attrs:{"label-width":"100px","label-suffix":"：",model:e.form,rules:e.rules}},[t("el-form-item",{attrs:{label:"选择标签/客群",prop:"attrType","label-width":"130px"}},[t("el-radio-group",{on:{change:e.changeAttrType},model:{value:e.form.attrType,callback:function(t){e.$set(e.form,"attrType",t)},expression:"form.attrType"}},[t("el-radio",{attrs:{label:"0"}},[e._v("标签")]),t("el-radio",{attrs:{label:"1"}},[e._v("客群")]),t("el-radio",{attrs:{label:"2"}},[e._v("基础客群 + 标签")])],1)],1),t("el-form-item",{directives:[{name:"show",rawName:"v-show",value:"1"!==e.form.attrType,expression:"form.attrType !== '1'"}],attrs:{label:"标签"}},[t("div",{staticStyle:{width:"95%"}},[t("LabelSelect",{ref:"labelSelectRef",on:{add:e.addLabel}})],1)]),t("CustomerList",{directives:[{name:"show",rawName:"v-show",value:"0"!==e.form.attrType,expression:"form.attrType !== '0'"}],ref:"customerListRef",attrs:{isValidateNotComplete:"",multiple:!0,selectList:e.form.selectCustomerList},on:{select:e.selectCustomer}}),[e._l(e.form.children,(function(r,s){return t("div",{key:r.sceneId},["1"!==e.form.attrType?t("SceneChild",{ref:"fissionSceneRef"+s,refInFor:!0,attrs:{aiHelp:"",labelWidth:"100px",title:"客群规则"+(s+1),childIndex:s,selectedColumns:e.form.selectAttrList,echoData:r,node:e.node},on:{remove:function(t){return e.removeScene(s)}}}):e._e()],1)})),"1"!==e.form.attrType?t("div",{staticClass:"add_scene_btn"},[t("span",{on:{click:e.addScene}},[e._v("+添加客群规则")])]):e._e()]],2),t("div",{staticClass:"match-table"},[t("header",{staticClass:"sub-header"},[e._v("匹配度分析：")]),t("el-table",{attrs:{border:"",data:e.matchList}},[t("el-table-column",{attrs:{type:"index",label:"序号",width:"45",align:"center"}}),t("el-table-column",{attrs:{label:"目标产品","show-overflow-tooltip":""}},[[e._v(" "+e._s(e.parentInfo.productList[0].planName)+" ")]],2),t("el-table-column",{attrs:{label:"目标客群","show-overflow-tooltip":""},scopedSlots:e._u([{key:"default",fn:function({row:t,$index:r}){return[e._v(" "+e._s("1"===e.form.attrType?t.customGroupName:"客群规则"+(r+1))+" ")]}}])}),t("el-table-column",{attrs:{label:"操作",width:"120",align:"center"},scopedSlots:e._u([{key:"default",fn:function({row:r}){return[t("el-button",{attrs:{disabled:!r.finalExpression,type:"text",size:"mini"},on:{click:function(t){return e.openMatchDialog(r.finalExpression)}}},[e._v("匹配度分析")])]}}])})],1)],1),t("ProductCustomerMatchDialog",{ref:"matchRef"})],1)},i=[],o=(r("d9e2"),r("14d9"),r("0fea")),a=r("afd9"),l=r("bdad"),n=r("82be"),c=r("2ef0");const m={sceneId:"",sceneName:"",attrType:"0",selectCustomerList:[],customerInfo:{},customerGroupId:void 0,selectAttrList:[],selectAttrStr:"",customerNum:null,finalExpression:null,conditionDesc:"",conditionParams:[],conditions:[],validateC:null,children:[]};var u={components:{SelectView:()=>r.e("chunk-67a56326").then(r.bind(null,"dec5")),SceneChild:()=>r.e("chunk-7a3acc7a").then(r.bind(null,"2283")),LabelSelect:()=>r.e("chunk-2d209afd").then(r.bind(null,"a9b1")),CustomerList:()=>r.e("chunk-3839fbc3").then(r.bind(null,"67a1")),CustomerChild:()=>r.e("chunk-6d7f6016").then(r.bind(null,"9357")),ProductCustomerMatchDialog:()=>r.e("chunk-38b49398").then(r.bind(null,"dbeb"))},props:{node:{type:Object,default:()=>({})},initialData:{type:Object,default:()=>({})},parentInfo:{type:Object,default:()=>({})}},watch:{},data(){return{form:Object(c["cloneDeep"])(m),rules:{attrType:[{required:!0,message:"请选择标签/客群",trigger:"change"}],selectCustomerList:[{required:!0,message:"请选择客群",trigger:"blur"},{validator:(e,t,r)=>{0===t.length&&"1"===this.form.attrType?r(new Error("请选择客群")):r()},trigger:"change"}]},ruleLoading:!1,matchList:[]}},methods:{changeAttrType(e,t=!0){t&&(this.form.children=[]),this.$nextTick(()=>{this.matchList="0"===e?this.form.children:"1"===e?this.form.selectCustomerList:this.form.children})},async selectCustomer(e,t){this.form.selectCustomerList=e,"1"===this.form.attrType&&(this.matchList=this.form.selectCustomerList);const{type:r,current:s}=t;if("add"===r&&!s.finalExpression){const e=Object(n["e"])([],{customerInfo:{columnNum:s.columnNum}});try{this.ruleLoading=!0;const{finalExpression:t}=await Object(o["i"])(a["a"].getTargetUserCount,e);s.finalExpression=t,t||this.$alert("不支持该客群，请重新选择！","提示",{confirmButtonText:"确定",customClass:"errorPrompt",callback:()=>{const e=this.form.selectCustomerList.findIndex(e=>e.customGroupId===s.customGroupId);this.form.selectCustomerList.splice(e,1)}})}catch(i){if("add"!=t.type)return;const e=this.form.selectCustomerList.findIndex(e=>e.customGroupId===s.customGroupId);this.form.selectCustomerList.splice(e,1)}finally{this.ruleLoading=!1}}},addLabel(e){let t=this.form.selectAttrList.find(t=>t.columnNum===e.columnNum);t?t.valueList||(this.form.selectAttrList=this.form.selectAttrList.map(t=>t.columnNum===e.columnNum?e:t)):this.form.selectAttrList.push(e),this.form.selectAttrStr=this.form.selectAttrList.map(e=>e.columnNum).join(",")},addScene(){const e={...Object(c["cloneDeep"])(m),sceneId:Object(l["c"])(),attrType:this.form.attrType,selectCustomerList:this.form.selectCustomerList};this.form.children.push(e)},removeScene(e){this.form.children.splice(e,1)},async validateFissionScene(){try{if(await this.$refs.outFormRef.validate(),"1"===this.form.attrType)return this.form.selectCustomerList.length?this.form.selectCustomerList:(this.$message.error("请选择客群"),Promise.reject("请选择客群"));{if(!this.form.children.length)return this.$message.error("请添加客群规则"),Promise.reject("请添加客群规则");let e=[];for(let r=0;r<this.form.children.length;r++){const t=this.$refs["fissionSceneRef"+r][0];e.push(t.validate())}const t=await Promise.all(e);return t}}catch(e){return Promise.reject(e)}},async validateScene(){await this.$refs.outFormRef.validate();const e="1"===this.form.attrType?this.$refs.fissionCustomerSceneRef:this.$refs.fissionSceneRef;return e.validate()},openMatchDialog(e){this.$refs.matchRef.open({dnaRule:e,productId:this.parentInfo.productList[0].planId})},clearCache(){"0"===this.form.attrType?this.form.selectCustomerList=[]:"1"===this.form.attrType?(this.form.selectAttrList=[],this.form.selectAttrStr=""):this.form.attrType},async validate(){try{const e=await this.validateFissionScene(),t=JSON.parse(JSON.stringify(this.form));return"1"!=this.form.attrType&&(t.children=e),t}catch(e){return Promise.reject(e)}}},created(){this.form={...this.form,...this.initialData},this.changeAttrType(this.form.attrType,!1)}},d=u,f=(r("59e7"),r("2877")),h=Object(f["a"])(d,s,i,!1,null,"67a4298f",null);t["default"]=h.exports},"59e7":function(e,t,r){"use strict";r("f081")},f081:function(e,t,r){}}]);