<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.asiainfo.biapp.pec.plan.jx.camp.dao.McdCampsegJxDao">

    <select id="getCampsegBaseInfo" resultType="com.asiainfo.biapp.pec.plan.jx.camp.req.CampBaseInfoJxVO">
         select distinct mcd.*, msu.USER_NAME CREATE_USER_NAME, mccl.CUSTGROUP_SOURCE, mccl.UPDATE_CYCLE DNA_UPDATE_CYCLE
         from mcd_camp_def mcd
         left join mcd_sys_user msu on mcd.CREATE_USER_ID = msu.USER_ID
         left join mcd_camp_channel_list mccl on mcd.CAMPSEG_ID = mccl.CAMPSEG_ROOT_ID
         where mcd.campseg_id = #{campsegId,jdbcType=VARCHAR}
    </select>

    <select id="getCampsegBaseInfoByRootId" resultType="com.asiainfo.biapp.pec.plan.jx.camp.req.CampBaseInfoJxVO">
         select *
        from mcd_camp_def
        where campseg_root_id = #{campsegRootId,jdbcType=VARCHAR}
    </select>

    <select id="queryHisCamp" resultType="com.asiainfo.biapp.pec.plan.jx.camp.vo.HisCampInfo">
        select mccl.CAMPSEG_ROOT_ID,
               mccl.CAMPSEG_ID,
               mcd.CAMPSEG_NAME,
               mccl.CHANNEL_ID,
               mdc.CHANNEL_NAME,
               mcd.CREATE_USER_ID,
               msu.USER_NAME as CREATE_USER_NAME
        from mcd_camp_channel_list mccl
                 left join mcd_camp_def mcd on mccl.CAMPSEG_ROOT_ID = mcd.CAMPSEG_ID
                 left join mcd_dim_channel mdc on mccl.CHANNEL_ID = mdc.CHANNEL_ID
                 left join mcd_sys_user msu on mcd.CREATE_USER_ID = msu.USER_ID
        <where>
            <foreach collection="channelIds" item="item" index="index" separator="," open="mccl.CHANNEL_ID in (" close=")">
                #{item,jdbcType=VARCHAR}
            </foreach>
            <if test="custgroupId != null and custgroupId != '' ">
                and mccl.CUSTGROUP_ID  = #{custgroupId,jdbcType=VARCHAR}
            </if>
            and mccl.STATUS='54'
        </where>
        order by mccl.CAMPSEG_ID desc
    </select>
    <select id="getChannelIdByCamprootId" resultType="java.lang.String">
        select CHANNEL_ID from MCD_CAMP_CHANNEL_LIST where CAMPSEG_ROOT_ID=#{campsegRootId,jdbcType=VARCHAR}
    </select>
    <select id="queryCampExcuteInfo" resultType="com.asiainfo.biapp.pec.plan.jx.camp.vo.McdCampExcuteInfo">
        select mccl.CHANNEL_ID        as channelId,
               mdc.CHANNEL_NAME       as channelName,
               count(mccl.CAMPSEG_ID) as campsegNum,
               sum(mcd.CUSTOM_NUM)    as useCustNum
        from mcd_camp_def mcad
                 left join MCD_CAMP_CHANNEL_LIST mccl on mccl.campseg_pid = mcad.campseg_id
                 left join MCD_DIM_CHANNEL mdc on mccl.CHANNEL_ID = mdc.CHANNEL_ID
                 left join mcd_custgroup_def mcd on mccl.CUSTGROUP_ID = mcd.CUSTOM_GROUP_ID
        where mccl.CHANNEL_ID in
        <if test="list.size()>0">
            <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        and mcad.CAMPSEG_STAT_ID = '54'
        group by mccl.CHANNEL_ID
        order by mccl.CHANNEL_ID desc
    </select>

    <select id="queryActivityList" resultType="map">

         SELECT T.ACTIVITY_ID, T.ACTIVITY_NAME  ,T.ACTIVITY_STATUS , T1.CAMPSEG_STAT_ID
         from IOP_ACTIVITY_INFO T
         JOIN  MCD_CAMP_DEF T1 ON T.ACTIVITY_ID = T1.CAMPSEG_ID

    </select>

    <select id="queryIopTemplate"  resultType="map">
        select a.ACTIVITY_TEMPLATE_ID, b.ACTIVITY_NAME, b.ACTIVITY_TYPE, 1 IS_IOP_TEMPLATE
        from IOP_USER_TEMPLATE_RELATION a
        left join IOP_ACTIVITY_INFO b on a.activity_template_id = b.activity_templateid
        where 1=1
        <if test="userId != null and userId != '' ">
            and a.user_id = #{userId}
        </if>
        and a.activity_template_id in (select bb.activity_templateid
        from (select activity_template_id, count(c.campseg_id) countA
        from mcd_camp_def c
        right join IOP_ACTIVITY_INFO d on d.activity_templateid = c.activity_template_id
        where c.CAMPSEG_ROOT_ID = '0'
        group by activity_template_id) aa
        right join (select f.activity_templateid, count(f.activity_templateid) countB
        from IOP_COMPAIGN_INFO e
        right join IOP_ACTIVITY_INFO f on e.activity_id = f.activity_id
        group by f.activity_templateid) bb
        on aa.activity_template_id = bb.activity_templateid
        where countA is null
        or countA <![CDATA[<]]> 10000)
        union
        select d.id ACTIVITY_TEMPLATE_ID, d.name ACTIVITY_NAME, e.ACTIVITY_TYPE, 2 IS_IOP_TEMPLATE
        from iop_camp_template d
        left join mcd_camp_def e on d.CAMPSEG_ID = e.CAMPSEG_ID
        where d.EXCELLENT_CASE = 1
    </select>

    <select id="queryCampExecInfo" resultType="com.asiainfo.biapp.pec.plan.jx.camp.model.CampExecInfo">
        select mccl.CAMPSEG_ID                      campsegId,
               mccl.CAMPSEG_ROOT_ID                 campsegRootId,
               mccl.CHANNEL_ID                      channelId,
               mccl.CHANNEL_ADIV_ID                 channelAdivId,
               mdc.CHANNEL_NAME                     channelName,
               mdai.ADIV_NAME                       channelAdivName,
               DATE_FORMAT(t.DATA_DATE,'%Y%m%d')    dataDate,
               format(ifnull(PV_CNT, 0), 0)         showNumDay,
               format(ifnull(PV_CNT_TOTAL, 0), 0)   showNumAll,
               format(ifnull(CK_CNT, 0), 0)         clickNumDay,
               format(ifnull(CK_CNT_TOTAL, 0), 0)   clickNumAll,
               format(ifnull(SUCC_NUM, 0), 0)       orderNumDay,
               format(ifnull(SUCC_NUM_TOTAL, 0), 0) orderNumAll,
               format(ifnull(SMS_CNT, 0), 0)        smsNumDay,
               format(ifnull(SMS_NUM_TOTAL, 0), 0)  smsNumAll
        from mcd_camp_channel_list mccl
                 left join mcd_dim_channel mdc on mccl.CHANNEL_ID = mdc.CHANNEL_ID
                 left join mcd_dim_adiv_info mdai on mccl.CHANNEL_ID = mdai.CHANNEL_ID and mccl.CHANNEL_ADIV_ID = mdai.ADIV_ID
                 left join
             (select DATA_DATE,
                     CHANNEL_ID,
                     CAMPSEG_PID,
                     CAMPSEG_ID,
                     PV_CNT,
                     PV_CNT_TOTAL,
                     CK_CNT,
                     CK_CNT_TOTAL,
                     SUCC_NUM,
                     SUCC_NUM_TOTAL,
                     SMS_CNT,
                     SMS_NUM_TOTAL
              from MCD_LOG_CAMP_EXEC
              where 1 = 1
              <if test="param.campsegRootId != null and param.campsegRootId != '' ">
                  and CAMPSEG_PID = #{param.campsegRootId}
              </if>
              <if test="param.campsegId != null and param.campsegId != '' ">
                 and CAMPSEG_ID = #{param.campsegId}
              </if>
              <if test="param.channelId != null and param.channelId != '' ">
                 and CHANNEL_ID = #{param.channelId}
              </if>
              <if test="param.startDate != null and param.startDate != '' ">
                 and DATA_DATE between str_to_date(#{param.startDate}, '%Y%m%d%H%i%s') and str_to_date(#{param.endDate}, '%Y%m%d%H%i%s')
              </if>  ) t
        on mccl.CAMPSEG_ID = t.CAMPSEG_ID and mccl.CAMPSEG_ROOT_ID = t.CAMPSEG_PID and mccl.CHANNEL_ID = t.CHANNEL_ID
        where  1=1
        <if test="param.campsegRootId != null and param.campsegRootId != '' ">
            and mccl.CAMPSEG_ROOT_ID = #{param.campsegRootId}
        </if>
        <if test="param.campsegId != null and param.campsegId != '' ">
            and mccl.CAMPSEG_ID = #{param.campsegId}
        </if>
        <if test="param.channelId != null and param.channelId != '' ">
            and mccl.CHANNEL_ID = #{param.channelId}
        </if>
        order by t.DATA_DATE desc
    </select>

    <select id="queryCampScene" resultType="map">
        select * from MCD_CAMP_SCENE_CONFIG
    </select>

</mapper>
