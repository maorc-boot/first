<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.asiainfo.biapp.pec.plan.jx.hmh5.dao.McdSmsTemplateDao">

    <select id="getCareSmsTemplate" resultType="com.asiainfo.biapp.pec.plan.jx.hmh5.vo.McdCareSmsTemplateResp">
        select
        mcst.TEMPLATE_CODE templateCode,
        decode(mcst.MSG_SMS_PLAT, 'hmh5', '普通短信', '代维短信') as msgSmsPlat,
        mcst.TEMPLATE_TYPE templateType, mcst.TEMPLATE_CONTENT templateContent, to_char(mcst.VALID_DEADLINE, 'YYYY-MM-DD') validDeadLine,
        case mcst.STATUS  when 0 then '未引用' when 1 then '已引用' else '已弃用' end as statusStr, mcst.APPROVAL_STATUS approvalStatus,
        case mcst.APPROVAL_STATUS when 20 then '草稿' when 40 then '审批中' when 41 then '审批退回' when 42 then '审批终止' else '审批通过' end as approvalStatusStr,
        mcst.CREATE_TIME createTime, uu.USERNAME userName, mcst.CREATE_USERID createUserId
        from MCD_CARE_SMS_TEMPALTE mcst
        left join user_user uu on mcst.CREATE_USERID = uu.USERID
        <where>
            <if test="query.userName != '' and query.userName != null">
                and uu.USERNAME like '%'||#{query.userName}||'%'
            </if>
            <if test="query.keyWords != '' and query.keyWords != null">
                and (mcst.TEMPLATE_CONTENT like '%'||#{query.keyWords}||'%'
                or mcst.TEMPLATE_CODE like '%'||#{query.keyWords}||'%')
            </if>
            <if test="query.startTime != '' and query.startTime != null">
                and mcst.CREATE_TIME &gt;= #{query.startTime}
            </if>
            <if test="query.endTime != '' and query.endTime != null">
                and mcst.CREATE_TIME &lt;= #{query.endTime}
            </if>
            <if test="query.status != '' and query.status != null">
                and mcst.STATUS = #{query.status}
            </if>
        </where>
        order by mcst.CREATE_TIME DESC
    </select>

    <select id="getCustGroupVars" resultType="com.asiainfo.biapp.pec.plan.model.McdCustgroupAttrList">
        select TYPECODE attrCol, TYPENAME attrColName from MCD_FRONT_LINE_DIC where PCODE = #{pCode}
    </select>

    <select id="getCareSmsTemplateDetail" resultType="com.asiainfo.biapp.pec.plan.jx.hmh5.vo.McdCareSmsTemplateResp">
        select
        mcst.TEMPLATE_CODE templateCode,
        mcst.MSG_SMS_PLAT msgSmsPlat,
        mcst.TEMPLATE_TYPE templateType, mcst.TEMPLATE_CONTENT templateContent, mcst.VALID_DEADLINE validDeadLine,
        case mcst.STATUS  when 0 then '未引用' when 1 then '已引用' else '已弃用' end as statusStr, mcst.APPROVAL_STATUS approvalStatus,
        case mcst.APPROVAL_STATUS when 20 then '草稿' when 40 then '审批中' when 41 then '审批退回' when 42 then '审批终止' else '审批通过' end as approvalStatusStr,
        mcst.CREATE_TIME createTime, uu.USERNAME userName
        from MCD_CARE_SMS_TEMPALTE mcst
        left join user_user uu on mcst.CREATE_USERID = uu.USERID
        where mcst.TEMPLATE_CODE = #{templateCode} and mcst.STATUS != 2
    </select>

    <select id="getApproveInfo" resultType="Map">
        select distinct capr.NODE_NAME, capr.CREATE_DATE, capr.APPROVER_NAME,
        case capr.DEAL_STATUS
           when 0 then '待处理'
           when 1 then '通过'
           when 2 then '驳回'
           when 3 then '被撤回'
           else '撤回' end as DEAL_STATUS, capc.SYSTEM_ID
        from cmp_approval_process_conf capc
        left join cmp_approve_process_instance capi
        on capc.PROCESS_ID = capi.PROCESS_ID
        left join cmp_approve_process_record capr
        on capi.INSTANCE_ID = capr.INSTANCE_ID
        where capc.SYSTEM_ID = 'MESSAGE_TEMPLATE' and capr.BUSINESS_ID = #{templateCode}
    </select>

    <select id="qryApprRecord" resultType="com.asiainfo.biapp.pec.plan.jx.hmh5.vo.SmsTemplateApprRecord">
        select
        mcst.TEMPLATE_CODE templateCode, mcst.CREATE_TIME createTime, decode(mcst.TEMPLATE_TYPE, '作战地图', '作战地图', '短信模板') as type, uu.USERID createUserId, uu.USERNAME userName
        from MCD_CARE_SMS_TEMPALTE mcst
        left join user_user uu on mcst.CREATE_USERID = uu.USERID
        <where>
            <if test="templateCodes.size()>0">
                and mcst.TEMPLATE_CODE in
                <foreach collection="templateCodes" item="templateCode" open="(" close=")" separator=",">
                    #{templateCode,jdbcType=VARCHAR}
                </foreach>
            </if>
            <if test="query.userName != '' and query.userName != null">
                and uu.USERNAME like '%'||#{query.userName}||'%'
            </if>
            <choose>
                <when test="query.approvalType != null and query.approvalType != '' and query.approvalType == 'BATTLE_MAP'">
                    and mcst.TEMPLATE_TYPE = '作战地图'
                </when>
                <otherwise>
                    and mcst.TEMPLATE_TYPE != '作战地图'
                </otherwise>
            </choose>
        </where>
        order by mcst.CREATE_TIME DESC
    </select>

    <select id="getSeq" resultType="int">
        select SEQ_SMS_TEMPLATE.nextval from dual
    </select>

    <select id="getLabelListDaiwei" resultType="com.asiainfo.biapp.pec.plan.jx.hmh5.vo.McdFrontCareSmsLabel">
        SELECT * FROM MCD_FRONT_CARE_SMS_LABEL L WHERE L.DATA_STATE = 1
    </select>


    <select id="getRelaLabels" resultType="com.asiainfo.biapp.pec.plan.jx.hmh5.vo.McdFrontCareSmsLabel">
        SELECT L.* FROM MCD_FRONT_CARE_SMS_LABEL L
        INNER JOIN (SELECT R.LABEL_CODE FROM MCD_FRONT_CARE_SMS_LABEL_RELA R WHERE R.DATA_STATE = 1 AND R.SMS_TEMPLATE_CODE = #{smsTemplateCode} ) RL
        ON RL.LABEL_CODE = L.LABEL_CODE
    </select>

    <select id="selectCareSmsLabelCodeList" resultType="String">
        SELECT R.LABEL_CODE FROM MCD_FRONT_CARE_SMS_LABEL_RELA R WHERE R.DATA_STATE = 1 AND R.SMS_TEMPLATE_CODE = #{smsTemplateCode}
    </select>

    <delete id="deleteCareSmsLabelRela">
        DELETE FROM MCD_FRONT_CARE_SMS_LABEL_RELA RL
        WHERE RL.SMS_TEMPLATE_CODE = #{smsTemplateCode}
        AND RL.LABEL_CODE IN
        <foreach collection="labelCodeList" index="index" item="labelCode" open="(" separator="," close=")">
            #{labelCode}
        </foreach>
    </delete>

</mapper>
