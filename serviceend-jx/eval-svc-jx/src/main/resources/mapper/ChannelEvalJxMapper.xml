<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.asiainfo.biapp.pec.eval.jx.dao.ChannelEvalJxMapper">

    <select id="getCityById" resultType="Map">
        SELECT CITY_ID, CITY_NAME, PARENT_ID, DM_CITY_ID, DM_COUNTY_ID, DM_DEPT_ID, RESOURCE_TYPE, DM_TYPE_CODE, DM_TYPE_ID FROM MCD_SYS_CITY WHERE CITY_ID = #{cityId}
    </select>

    <select id="getChannelEffectList" resultType="Map" parameterType="com.asiainfo.biapp.pec.eval.model.req.ChannelEvaluateReqModel">
        SELECT
        A.STAT_TIME AS STAT_TIME,
        A.CHANNEL_NAME,
        A.CITY,
        A.PROVINCE,
        A.SERVICE_TYPE,
        A.CHANNEL_CODE,
        sum(ifnull(A.CAMPSEG_COUNT, 0))          AS CAMPSEG_COUNT,
        sum(ifnull(A.TARGET_USER_NUM, 0))       AS TARGET_USER_NUM,
        sum(ifnull(A.CAMP_USER_NUM, 0))          AS CAMP_USER_NUM,
        sum(ifnull(A.CAMP_SUCCESS_USER_NUM, 0))  AS CAMP_SUCCESS_USER_NUM,
        sum(ifnull(A.TOTAL_USER_NUM, 0))         AS TOTAL_USER_NUM,
        case when sum(CAMP_USER_NUM) = 0 then 0
        else sum(CAMP_SUCCESS_USER_NUM) / sum(CAMP_USER_NUM) end as CAMP_SUCCESS_RADIO,
        A.PARTICIPANT_USER_NUM,
        B.CITY_NAME
        FROM
        <if test = "dateType == 'day' || dateType == 'week'">
            mcd_evaluate_channel_d
        </if>
        <if test = "dateType == 'month'">
            mcd_evaluate_channel_m
        </if>
        A, MCD_SYS_CITY B
        WHERE A.CITY = B.CITY_ID
        <if test = "dateDayStart != null and dateDayStart !=''">
            AND A.STAT_TIME &gt;= #{dateDayStart}
        </if>
        <if test = "dateDayEnd != null and dateDayEnd !=''">
            AND A.STAT_TIME &lt;= #{dateDayEnd}
        </if>
        <if test="cityId != null and cityId != '' and cityId != '-1' and cityId != '0890'" >
            AND B.CITY_ID= #{cityId}
        </if>
        <if test="channelName != null and channelName != '' and channelName != '-1'">
            AND A.CHANNEL_NAME like concat('%',#{channelName},'%')
        </if>
        <if test="channelId != null and channelId != '' and channelId != '-1'">
            AND A.CHANNEL_CODE like concat('%',#{channelId},'%')
        </if>
        GROUP BY STAT_TIME, CHANNEL_CODE, CHANNEL_NAME, CITY_CODE, CITY_NAME
        ORDER BY A.CHANNEL_NAME and STAT_TIME desc
        limit ${pageStart}, ${pageSize}
    </select>

    <select id="getChannelEffectListTotal" parameterType="com.asiainfo.biapp.pec.eval.model.req.ChannelEvaluateReqModel" resultType="java.lang.Integer">
        SELECT count(1) FROM (
            SELECT A.STAT_TIME AS STAT_TIME,
            A.CHANNEL_NAME,
            A.CITY,
            A.PROVINCE,
            A.SERVICE_TYPE,
            A.CHANNEL_CODE,
            sum(ifnull(A.CAMPSEG_COUNT, 0))          AS CAMPSEG_COUNT,
            sum(ifnull(A.TARGET_USER_NUM, 0))       AS TARGET_USER_NUM,
            sum(ifnull(A.CAMP_USER_NUM, 0))          AS CAMP_USER_NUM,
            sum(ifnull(A.CAMP_SUCCESS_USER_NUM, 0))  AS CAMP_SUCCESS_USER_NUM,
            sum(ifnull(A.TOTAL_USER_NUM, 0))         AS TOTAL_USER_NUM,
            case when sum(CAMP_USER_NUM) = 0 then 0
            else sum(CAMP_SUCCESS_USER_NUM) / sum(CAMP_USER_NUM) end as CAMP_SUCCESS_RADIO,
            A.PARTICIPANT_USER_NUM,
            B.CITY_NAME
            FROM
            <if test = "dateType == 'day' || dateType == 'week'">
                mcd_evaluate_channel_d
            </if>
            <if test = "dateType == 'month'">
                mcd_evaluate_channel_m
            </if>
            A, MCD_SYS_CITY B
            WHERE A.CITY = B.CITY_ID
            <if test = "dateDayStart != null and dateDayStart !=''">
                AND A.STAT_TIME &gt;= #{dateDayStart}
            </if>
            <if test = "dateDayEnd != null and dateDayEnd !=''">
                AND A.STAT_TIME &lt;= #{dateDayEnd}
            </if>
            <if test="cityId != null and cityId != '' and cityId != '-1' and cityId != '0890'" >
                AND B.CITY_ID= #{cityId}
            </if>
            <if test="channelName != null and channelName != '' and channelName != '-1'">
                AND A.CHANNEL_NAME like concat('%',#{channelName},'%')
            </if>
            <if test="channelId != null and channelId != '' and channelId != '-1'">
                AND A.CHANNEL_CODE like concat('%',#{channelId},'%')
            </if>
            GROUP BY STAT_TIME, CHANNEL_CODE, CHANNEL_NAME, CITY_CODE, CITY_NAME
            ORDER BY A.CHANNEL_NAME and STAT_TIME desc
        ) total
    </select>

</mapper>
