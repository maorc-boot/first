<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.asiainfo.biapp.pec.eval.jx.dao.EffectEvalMapper">

    <select id="queryEffectEvaluationAllList" resultType="Map" parameterType="com.asiainfo.biapp.pec.eval.jx.req.EffectEvalReq">
       SELECT
       CT.CITY_NAME CITY_NAME,
       mpl.LABEL_VALUE LABEL_VALUE,
       MDC.CHANNEL_NAME CHANNEL_NAME,
       ifnull(COUNT(DISTINCT CMT.CAMPSEG_ID), 0) as CAMPSEG_CNT,
       SUM(ifnull(CMT.CAMP_USER_NUM, 0)) as CAMP_USER_NUM_CNT,
       SUM(ifnull(CMT.CAMP_SUCC_NUM, 0)) as CAMP_SUCC_NUM_CNT,
       SUM(ifnull(CMT.TARGET_USER_NUM, 0)) as TARGET_USER_NUM_CNT,
       case when SUM(ifnull(CMT.CAMP_USER_NUM, 0)) = 0 then 0
           else SUM(ifnull(CMT.CAMP_SUCC_NUM, 0)) / SUM(ifnull(CMT.CAMP_USER_NUM, 0)) end as SUCC_RATE,
       case when SUM(ifnull(CMT.TARGET_USER_NUM, 0)) = 0 then 0
           else SUM(ifnull(CMT.CAMP_USER_NUM, 0)) / SUM(ifnull(CMT.TARGET_USER_NUM, 0)) end as CAMP_USER_RATE
        FROM
        <if test = "dateType == 'day' || dateType == 'week'">
            mtl_eval_info_campseg_d
        </if>
        <if test = "dateType == 'month'">
            mtl_eval_info_campseg_m
        </if>
        CMT
       LEFT JOIN mcd_camp_channel_list CD ON CD.CAMPSEG_ID = CMT.CAMPSEG_ID
       LEFT JOIN mcd_sys_city CT ON CT.CITY_ID = CMT.CITY_ID
       LEFT JOIN mcd_plan_def PD ON PD.PLAN_ID = CD.PLAN_ID
       LEFT JOIN MCD_DIM_CHANNEL MDC ON MDC.CHANNEL_ID = CMT.CHANNEL_ID
       LEFT JOIN mcd_plan_label mpl ON PD.PROD_CLASS_BUSI = mpl.LABEL_VALUE and mpl.LABEL_KEY = 'PROD_CLASS_BUSI'
        WHERE 1 = 1
        <if test = "cityId != null and cityId !=''">
            and CMT.CITY_ID = #{cityId}
        </if>
        <if test = "channelId != null and channelId !=''">
            and CMT.CHANNEL_ID = #{channelId}
        </if>
        <if test = "startDate != null and startDate !=''">
            and CMT.STAT_DATE &gt;= #{startDate}
        </if>
        <if test = "endDate != null and endDate !=''">
            and CMT.STAT_DATE &lt;= #{endDate}
        </if>
        <if test = "productType != null and productType !=''">
            and mpl.LABEL_VALUE = #{productType}
        </if>
    </select>

    <select id="getDetailByDrillDownType" resultType="Map" parameterType="com.asiainfo.biapp.pec.eval.jx.req.EffectEvalReq">
        SELECT PD.PLAN_NAME PLAN_NAME, mcd.CAMPSEG_NAME CAMPSEG_NAME, CMT.STAT_DATE STAT_DATE,
        dpc.COUNTY_NAME COUNTY_NAME, mdai.ADIV_NAME ADIV_NAME,
        CT.CITY_NAME CITY_NAME,
        mpl.LABEL_VALUE LABEL_VALUE,
        MDC.CHANNEL_NAME CHANNEL_NAME,
        ifnull(COUNT(DISTINCT CMT.CAMPSEG_ID), 0) as CAMPSEG_CNT,
        SUM(ifnull(CMT.CAMP_USER_NUM, 0)) as CAMP_USER_NUM_CNT,
        SUM(ifnull(CMT.CAMP_SUCC_NUM, 0)) as CAMP_SUCC_NUM_CNT,
        SUM(ifnull(CMT.TARGET_USER_NUM, 0)) as TARGET_USER_NUM_CNT,
        case when SUM(ifnull(CMT.CAMP_USER_NUM, 0)) = 0 then 0
        else SUM(ifnull(CMT.CAMP_SUCC_NUM, 0)) / SUM(ifnull(CMT.CAMP_USER_NUM, 0)) end as SUCC_RATE,
        case when SUM(ifnull(CMT.TARGET_USER_NUM, 0)) = 0 then 0
        else SUM(ifnull(CMT.CAMP_USER_NUM, 0)) / SUM(ifnull(CMT.TARGET_USER_NUM, 0)) end as CAMP_USER_RATE
        FROM
        <if test = "dateType == 'day' || dateType == 'week'">
            mtl_eval_info_campseg_d
        </if>
        <if test = "dateType == 'month'">
            mtl_eval_info_campseg_m
        </if>
        CMT
        LEFT JOIN mcd_camp_channel_list CD ON CD.CAMPSEG_ID = CMT.CAMPSEG_ID
        LEFT JOIN mcd_camp_def mcd on cd.CAMPSEG_ROOT_ID = mcd.CAMPSEG_ROOT_ID
        LEFT JOIN mcd_sys_city CT ON CT.CITY_ID = CMT.CITY_ID
        LEFT JOIN DIM_PUB_COUNTY dpc on CMT.COUNTY_ID = dpc.COUNTY_ID
        LEFT JOIN mcd_plan_def PD ON PD.PLAN_ID = CD.PLAN_ID
        LEFT JOIN MCD_DIM_CHANNEL MDC ON MDC.CHANNEL_ID = CMT.CHANNEL_ID
        LEFT JOIN mcd_plan_label mpl ON PD.PROD_CLASS_BUSI = mpl.LABEL_VALUE and mpl.LABEL_KEY = 'PROD_CLASS_BUSI'
        LEFT JOIN mcd_dim_adiv_info mdai on CD.CHANNEL_ADIV_ID = mdai.ADIV_ID
        WHERE 1 = 1
        <if test = "cityId != null and cityId !=''">
            and CMT.CITY_ID = #{cityId}
        </if>
        <if test = "channelId != null and channelId !=''">
            and CMT.CHANNEL_ID = #{channelId}
        </if>
        <if test = "startDate != null and startDate !=''">
            and CMT.STAT_DATE &gt;= #{startDate}
        </if>
        <if test = "endDate != null and endDate !=''">
            and CMT.STAT_DATE &lt;= #{endDate}
        </if>
        <if test = "productType != null and productType !=''">
            and mpl.LABEL_VALUE = #{productType}
        </if>
        <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'time'">
            group by CMT.STAT_DATE
        </if>
        <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'province'">
            group by CMT.CITY_ID
        </if>
        <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'city'">
            group by CMT.COUNTY_ID
        </if>
        <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'productType'">
            group by mpl.LABEL_VALUE
        </if>
        <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'channel'">
            group by CMT.CHANNEL_ID
        </if>
        <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'adiv'">
            group by mdai.ADIV_ID
        </if>
        order by CMT.STAT_DATE
        limit ${pageStart}, ${pageSize}
    </select>

    <select id="getDetailByDrillDownTypeCount" resultType="integer" parameterType="com.asiainfo.biapp.pec.eval.jx.req.EffectEvalReq">
        select count(1) from(
            SELECT
            CT.CITY_NAME CITY_NAME,
            mpl.LABEL_VALUE LABEL_VALUE,
            MDC.CHANNEL_NAME CHANNEL_NAME,
            ifnull(COUNT(DISTINCT CMT.CAMPSEG_ID), 0) as CAMPSEG_CNT,
            SUM(ifnull(CMT.CAMP_USER_NUM, 0)) as CAMP_USER_NUM_CNT,
            SUM(ifnull(CMT.CAMP_SUCC_NUM, 0)) as CAMP_SUCC_NUM_CNT,
            SUM(ifnull(CMT.TARGET_USER_NUM, 0)) as TARGET_USER_NUM_CNT,
            case when SUM(ifnull(CMT.CAMP_USER_NUM, 0)) = 0 then 0
            else SUM(ifnull(CMT.CAMP_SUCC_NUM, 0)) / SUM(ifnull(CMT.CAMP_USER_NUM, 0)) end as SUCC_RATE,
            case when SUM(ifnull(CMT.TARGET_USER_NUM, 0)) = 0 then 0
            else SUM(ifnull(CMT.CAMP_USER_NUM, 0)) / SUM(ifnull(CMT.TARGET_USER_NUM, 0)) end as CAMP_USER_RATE
            FROM
            <if test = "dateType == 'day' || dateType == 'week'">
                mtl_eval_info_campseg_d
            </if>
            <if test = "dateType == 'month'">
                mtl_eval_info_campseg_m
            </if>
            CMT
            LEFT JOIN mcd_camp_channel_list CD ON CD.CAMPSEG_ID = CMT.CAMPSEG_ID
            LEFT JOIN mcd_sys_city CT ON CT.CITY_ID = CMT.CITY_ID
            LEFT JOIN mcd_plan_def PD ON PD.PLAN_ID = CD.PLAN_ID
            LEFT JOIN MCD_DIM_CHANNEL MDC ON MDC.CHANNEL_ID = CMT.CHANNEL_ID
            LEFT JOIN mcd_plan_label mpl ON PD.PROD_CLASS_BUSI = mpl.LABEL_VALUE and mpl.LABEL_KEY = 'PROD_CLASS_BUSI'
            <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'adiv'">
                left join mcd_dim_adiv_info mdai on CD.CHANNEL_ADIV_ID = mdai.ADIV_ID
            </if>
            WHERE 1 = 1
            <if test = "cityId != null and cityId !=''">
                and CMT.CITY_ID = #{cityId}
            </if>
            <if test = "channelId != null and channelId !=''">
                and CMT.CHANNEL_ID = #{channelId}
            </if>
            <if test = "startDate != null and startDate !=''">
                and CMT.STAT_DATE &gt;= #{startDate}
            </if>
            <if test = "endDate != null and endDate !=''">
                and CMT.STAT_DATE &lt;= #{endDate}
            </if>
            <if test = "productType != null and productType !=''">
                and mpl.LABEL_VALUE = #{productType}
            </if>
            <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'time'">
                group by CMT.STAT_DATE
            </if>
            <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'province'">
                group by CMT.CITY_ID
            </if>
            <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'city'">
                group by CMT.COUNTY_ID
            </if>
            <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'productType'">
                group by mpl.LABEL_VALUE
            </if>
            <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'channel'">
                group by CMT.CHANNEL_ID
            </if>
            <if test = "drillDownType != null and drillDownType !='' and drillDownType == 'adiv'">
                group by mdai.ADIV_ID
            </if>
            order by CMT.STAT_DATE
        ) total
    </select>

</mapper>
