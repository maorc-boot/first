<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.asiainfo.biapp.pec.eval.jx.dao.EvalHomeDao">


    <select id="queryTotal" resultType="com.asiainfo.biapp.pec.eval.jx.vo.EvalHomeDataVo"
            parameterType="com.asiainfo.biapp.pec.eval.jx.req.EvalHomeReq">


        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='STAT_DATE'.toString()">

            select  t.STAT_DATE as name ,
            sum(ifnull(t.CAMP_USER_NUM, 0)) as value
            from mtl_eval_info_plan_${param.type} t
            <where>
                <if test="param.startDate != null and param.startDate != '' ">
                    t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                </if>
                <if test="param.endDate != null and param.endDate != '' ">
                    AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                </if>
            </where>
            group by t.${param.groupByCol}
        </if>

        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='CHANNEL_NAME'.toString()">

            select   ch.CHANNEL_NAME as name ,
            sum(ifnull(t.CAMP_USER_NUM, 0)) as value
            from mtl_eval_info_plan_${param.type} t
            left join mcd_dim_channel ch on ch.channel_id = t.channel_id
            <where>
                <if test="param.startDate != null and param.startDate != '' ">
                    t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                </if>
                <if test="param.endDate != null and param.endDate != '' ">
                    AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                </if>
            </where>
            group by ch.CHANNEL_NAME
        </if>


        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='CITY'.toString()">
            <if test="param.cityId != null and param.cityId != ''">

                select   cy.COUNTY_NAME as name ,
                sum(ifnull(t.CAMP_USER_NUM, 0)) as value
                from mtl_eval_info_plan_${param.type} t

                left join  dim_pub_county cy on cy.CITY_ID = t.CITY_ID and cy.COUNTY_ID = t.COUNTY_ID

                where t.CITY_ID =  #{param.cityId }

                    <if test="param.startDate != null and param.startDate != '' ">
                        and t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                    </if>
                    <if test="param.endDate != null and param.endDate != '' ">
                        AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                    </if>

                group by cy.COUNTY_NAME
            </if>

            <if test="param.cityId != null and param.cityId == ''">
                select   ct.CITY_NAME as name ,
                sum(ifnull(t.CAMP_USER_NUM, 0)) as value

                from mtl_eval_info_plan_${param.type} t
                left join mcd_sys_city ct on ct.CITY_ID = t.CITY_ID

                <where>
                    <if test="param.startDate != null and param.startDate != '' ">
                        t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                    </if>
                    <if test="param.endDate != null and param.endDate != '' ">
                        AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                    </if>
                </where>
                group by ct.CITY_NAME
            </if>

        </if>

       <!-- select ${param.groupByCol} as name ,
        sum(ifnull(t.CAMP_USER_NUM, 0)) as value
        from mcd_evaluate_channel_${param.type} t
        <where>
            <if test="param.startDate != null and param.startDate != '' ">
                t.STAT_TIME <![CDATA[>=]]> #{param.startDate}
            </if>
            <if test="param.endDate != null and param.endDate != '' ">
                AND t.STAT_TIME <![CDATA[<=]]> #{param.endDate}
            </if>
        </where>
        group by t.${param.groupByCol};-->
    </select>


    <select id="querySuccess" resultType="com.asiainfo.biapp.pec.eval.jx.vo.EvalHomeDataVo"
            parameterType="com.asiainfo.biapp.pec.eval.jx.req.EvalHomeReq">

        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='STAT_DATE'.toString()">
            select t.STAT_DATE as name ,
            sum(ifnull(t.CAMP_SUCC_NUM, 0)) as value
            from mtl_eval_info_plan_${param.type} t
            <where>
                <if test="param.startDate != null and param.startDate != '' ">
                    t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                </if>
                <if test="param.endDate != null and param.endDate != '' ">
                    AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                </if>
            </where>
            group by t.STAT_DATE

        </if>


        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='CHANNEL_NAME'.toString()">
            select   ch.CHANNEL_NAME as name ,
            sum(ifnull(t.CAMP_SUCC_NUM, 0)) as value
            from mtl_eval_info_plan_${param.type} t
            left join mcd_dim_channel ch on ch.channel_id = t.channel_id
            <where>
                <if test="param.startDate != null and param.startDate != '' ">
                    t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                </if>
                <if test="param.endDate != null and param.endDate != '' ">
                    AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                </if>
            </where>
            group by ch.CHANNEL_NAME

        </if>


        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='CITY'.toString()">
            <if test="param.cityId != null and param.cityId != ''">

                select   cy.COUNTY_NAME as name ,
                sum(ifnull(t.CAMP_SUCC_NUM, 0)) as value
                from mtl_eval_info_plan_${param.type} t

                left join  dim_pub_county cy on cy.CITY_ID = t.CITY_ID and cy.COUNTY_ID = t.COUNTY_ID

                where t.CITY_ID = #{param.cityId}

                    <if test="param.startDate != null and param.startDate != '' ">
                       and t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                    </if>
                    <if test="param.endDate != null and param.endDate != '' ">
                        AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                    </if>

                group by cy.COUNTY_NAME
            </if>

            <if test="param.cityId != null and param.cityId == ''">
                select ct.CITY_NAME as name ,
                sum(ifnull(t.CAMP_SUCC_NUM, 0)) as value
                from mtl_eval_info_plan_${param.type} t
                left join mcd_sys_city ct on ct.CITY_ID = t.CITY_ID
                <where>
                    <if test="param.startDate != null and param.startDate != '' ">
                        t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                    </if>
                    <if test="param.endDate != null and param.endDate != '' ">
                        AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                    </if>
                </where>
                group by ct.CITY_NAME

            </if>


        </if>

       <!-- select ${param.groupByCol} as name ,
        sum(ifnull(t.CAMP_SUCCESS_USER_NUM, 0)) as value
        from mcd_evaluate_channel_${param.type} t
        <where>
            <if test="param.startDate != null and param.startDate != '' ">
                t.STAT_TIME <![CDATA[>=]]> #{param.startDate}
            </if>
            <if test="param.endDate != null and param.endDate != '' ">
                AND t.STAT_TIME <![CDATA[<=]]> #{param.endDate}
            </if>
        </where>
        group by t.${param.groupByCol};-->
    </select>

    <select id="querySuccessRate" resultType="com.asiainfo.biapp.pec.eval.jx.vo.EvalHomeDataVo"
            parameterType="com.asiainfo.biapp.pec.eval.jx.req.EvalHomeReq">



        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='STAT_DATE'.toString()">
            select a.${param.groupByCol} as name,
            case a.total when a.total = 0 then 0 else round((b.success / a.total)*100,2) end as value
            from
            (select t.${param.groupByCol}, sum(ifnull(t.CAMP_USER_NUM, 0)) as total from mtl_eval_info_plan_${param.type}
            t
            <where>
                <if test="param.startDate != null and param.startDate != '' ">
                    t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                </if>
                <if test="param.endDate != null and param.endDate != '' ">
                    AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                </if>
            </where>

            group by t.${param.groupByCol}) a
            join
            (select t.${param.groupByCol}, sum(ifnull(t.CAMP_SUCC_NUM, 0)) as success from
            mtl_eval_info_plan_${param.type} t
            <where>
                <if test="param.startDate != null and param.startDate != '' ">
                    t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                </if>
                <if test="param.endDate != null and param.endDate != '' ">
                    AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                </if>
            </where>
            group by t.${param.groupByCol}) b
            on a.${param.groupByCol} = b.${param.groupByCol}

        </if>
        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='CHANNEL_NAME'.toString()">

            select a.CHANNEL_NAME as name,
            case a.total when a.total = 0 then 0 else round((b.success / a.total)*100,2) end as value
            from
            ( select   ch.CHANNEL_NAME  ,
            sum(ifnull(t.CAMP_USER_NUM, 0)) as total
            from mtl_eval_info_plan_${param.type} t
            left join mcd_dim_channel ch on ch.channel_id = t.channel_id
            <where>
                <if test="param.startDate != null and param.startDate != '' ">
                    t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                </if>
                <if test="param.endDate != null and param.endDate != '' ">
                    AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                </if>
            </where>
            group by ch.CHANNEL_NAME ) a
            join
            ( select   ch.CHANNEL_NAME   ,
            sum(ifnull(t.CAMP_SUCC_NUM, 0)) as success
            from mtl_eval_info_plan_${param.type} t
            left join mcd_dim_channel ch on ch.channel_id = t.channel_id
            <where>
                <if test="param.startDate != null and param.startDate != '' ">
                    t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                </if>
                <if test="param.endDate != null and param.endDate != '' ">
                    AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                </if>
            </where>
            group by ch.CHANNEL_NAME ) b
            on a.CHANNEL_NAME = b.CHANNEL_NAME
        </if>
        <if test="param.groupByCol != null and param.groupByCol != '' and param.groupByCol =='CITY'.toString()">

            <if test="param.cityId != null and param.cityId != ''">
                select a.COUNTY_NAME as name,
                case a.total when a.total = 0 then 0 else round((b.success / a.total)*100,2) end as value
                from
                ( select   cy.COUNTY_NAME   ,
                sum(ifnull(t.CAMP_USER_NUM, 0)) as total

                from mtl_eval_info_plan_${param.type} t

                left join  dim_pub_county cy on cy.CITY_ID = t.CITY_ID and cy.COUNTY_ID = t.COUNTY_ID

                where t.CITY_ID =  #{param.cityId }
                    <if test="param.startDate != null and param.startDate != '' ">
                        and t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                    </if>
                    <if test="param.endDate != null and param.endDate != '' ">
                        AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                    </if>

                group by cy.COUNTY_NAME ) a
                join
                (   select   cy.COUNTY_NAME   ,
                sum(ifnull(t.CAMP_SUCC_NUM, 0)) as success
                from mtl_eval_info_plan_${param.type} t

                left join  dim_pub_county cy on cy.CITY_ID = t.CITY_ID and cy.COUNTY_ID = t.COUNTY_ID

                where t.CITY_ID = #{param.cityId}
                    <if test="param.startDate != null and param.startDate != '' ">
                        and t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                    </if>
                    <if test="param.endDate != null and param.endDate != '' ">
                        AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                    </if>

                group by cy.COUNTY_NAME ) b
                on a.COUNTY_NAME = b.COUNTY_NAME
            </if>

            <if test="param.cityId != null and param.cityId == ''">
                select a.CITY_NAME as name,
                case a.total when a.total = 0 then 0 else round((b.success / a.total)*100,2) end as value
                from
                ( select   ct.CITY_NAME   ,
                sum(ifnull(t.CAMP_USER_NUM, 0)) as total

                from mtl_eval_info_plan_${param.type} t
                left join mcd_sys_city ct on ct.CITY_ID = t.CITY_ID

                <where>
                    <if test="param.startDate != null and param.startDate != '' ">
                        t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                    </if>
                    <if test="param.endDate != null and param.endDate != '' ">
                        AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                    </if>
                </where>
                group by ct.CITY_NAME) a
                join
                ( select ct.CITY_NAME   ,
                sum(ifnull(t.CAMP_SUCC_NUM, 0)) as success
                from mtl_eval_info_plan_${param.type} t
                left join mcd_sys_city ct on ct.CITY_ID = t.CITY_ID
                <where>
                    <if test="param.startDate != null and param.startDate != '' ">
                        t.STAT_DATE <![CDATA[>=]]> #{param.startDate}
                    </if>
                    <if test="param.endDate != null and param.endDate != '' ">
                        AND t.STAT_DATE <![CDATA[<=]]> #{param.endDate}
                    </if>
                </where>
                group by ct.CITY_NAME) b
                on a.CITY_NAME = b.CITY_NAME
            </if>

        </if>

        <!--select a.${param.groupByCol} as name,
        case a.total when a.total = 0 then 0 else round((b.success / a.total)*100,2) end as value
        from
        (select t.${param.groupByCol}, sum(ifnull(t.CAMP_USER_NUM, 0)) as total from mcd_evaluate_channel_${param.type}
        t
        <where>
            <if test="param.startDate != null and param.startDate != '' ">
                t.STAT_TIME <![CDATA[>=]]> #{param.startDate}
            </if>
            <if test="param.endDate != null and param.endDate != '' ">
                AND t.STAT_TIME <![CDATA[<=]]> #{param.endDate}
            </if>
        </where>

        group by t.${param.groupByCol}) a
        join
        (select t.${param.groupByCol}, sum(ifnull(t.CAMP_SUCCESS_USER_NUM, 0)) as success from
        mcd_evaluate_channel_${param.type} t
        <where>
            <if test="param.startDate != null and param.startDate != '' ">
                t.STAT_TIME <![CDATA[>=]]> #{param.startDate}
            </if>
            <if test="param.endDate != null and param.endDate != '' ">
                AND t.STAT_TIME <![CDATA[<=]]> #{param.endDate}
            </if>
        </where>
        group by t.${param.groupByCol}) b
        on a.${param.groupByCol} = b.${param.groupByCol}-->
    </select>

    <select id="queryChnExec" resultType="com.asiainfo.biapp.pec.eval.jx.vo.EvalHomeChnExecVO">

        select t.STAT_DATE statTime ,
        sum(ifnull(t.CAMP_USER_NUM, 0)) as total,
        sum(ifnull(t.CAMP_SUCC_NUM, 0)) as success,
        IF( sum(t.CAMP_USER_NUM) = 0, 0, round((sum(t.CAMP_SUCC_NUM) / sum(t.CAMP_USER_NUM)) * 100, 2)) as
        successRate
        from mtl_eval_info_plan_m t

        <where>
            <if test="param.endMonth != null and param.endMonth != '' and  param.startMonth != null and param.startMonth != ''  ">
                t.STAT_TIME <![CDATA[<=]]> #{param.endMonth} and t.STAT_DATE <![CDATA[>=]]> #{param.startMonth}
            </if>
            <if test="param.currentMonth != null and param.currentMonth != ''  ">
                t.STAT_DATE = #{param.currentMonth}
            </if>
        </where>
        group by t.STAT_DATE
        order by t.STAT_DATE desc



        <!--select t.stat_time statTime ,
        sum(ifnull(t.CAMP_USER_NUM, 0)) as total,
        sum(ifnull(t.CAMP_SUCCESS_USER_NUM, 0)) as success,
        IF( sum(t.CAMP_USER_NUM) = 0, 0, round((sum(t.CAMP_SUCCESS_USER_NUM) / sum(t.CAMP_USER_NUM)) * 100, 2)) as
        successRate
        from mcd_evaluate_channel_M t

        <where>
            <if test="param.endMonth != null and param.endMonth != '' and  param.startMonth != null and param.startMonth != ''  ">
                t.STAT_TIME <![CDATA[<=]]> #{param.endMonth} and t.STAT_TIME <![CDATA[>=]]> #{param.startMonth}
            </if>
            <if test="param.currentMonth != null and param.currentMonth != ''  ">
                t.STAT_TIME = #{param.currentMonth}
            </if>
        </where>
        group by t.stat_time
        order by t.stat_time desc-->
    </select>

    <select id="queryCampStatistics" resultType="com.asiainfo.biapp.pec.eval.jx.vo.EvalHomeCampStatVO">
        select t.CITY_ID cityId,
        t.CITY_NAME cityName,
        sum(ifnull(t.JIECHU, 0)) as total,
        sum(ifnull(t.CHENGGONG, 0)) as success,
        IF( sum(t.JIECHU) = 0, 0, round((sum(t.CHENGGONG) / sum(t.JIECHU)) * 100, 2)) as successRate
        from MTL_CAMPSEG_EVAULATE_DAY t
        <where>
            <if test="param.campsegIdList != null">
                <foreach collection="param.campsegIdList" separator="," open="CAMPSEG_PID IN ( " close=" )"
                         item="campId">
                    #{campId}
                </foreach>
            </if>
            <if test="param.startDate != null and param.startDate !='' ">
                AND DATA_DATE  <![CDATA[>=]]> str_to_date(#{param.startDate},'%Y-%m-%d %T')
            </if>
            <if test="param.endDate != null and param.endDate !='' ">
                AND DATA_DATE  <![CDATA[<=]]> str_to_date(#{param.endDate},'%Y-%m-%d %T')
            </if>
            <if test="param.cityId != null and param.cityId !='' ">
                AND t.CITY_ID = #{param.cityId}
            </if>

        </where>
        group by t.CITY_ID, t.CITY_NAME order by t.CITY_ID
    </select>

    <select id="queryCampList" resultType="Map">
        select CAMPSEG_NAME, CAMPSEG_ID
        from mcd_camp_def t
        where t.CAMPSEG_STAT_ID in (54, 90, 91)
        and t.CAMPSEG_ROOT_ID = '0'
        <if test="keyword != null and keyword != ''">
            and (CAMPSEG_NAME like concat('%',#{keyword},'%') or CAMPSEG_ID like concat('%',#{keyword},'%'))
        </if>
        order by t.CREATE_TIME desc
    </select>

    <select id="queryAllCity" resultType="Map">
        select t.CITY_NAME ,t.CITY_ID  from mcd_sys_city t where t.CITY_ID <![CDATA[ != ]]>  '-1' order by t.CITY_ID ;
    </select>

</mapper>
