<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.asiainfo.biapp.pec.eval.jx.dao.SmartGridEvalMapper">

    <select id="querySmartGridEffect" parameterType="com.asiainfo.biapp.pec.eval.jx.req.SmartGridEvalReq" resultType="com.asiainfo.biapp.pec.eval.jx.vo.SmartGridEvalVo">
        SELECT
        CAMPSEG_NAME campsegName,
        CAMPSEG_PID campsegRootId,
        PLAN_NAME planName,
        PLAN_ID planId,
        START_DATE startDate,
        END_DATE endDate,
        <if test="param.cityId != '0'.toString()">
            CITY_ID cityId ,
            CITY_NAME cityName,
        </if>
        <if test="param.cityId != '0'.toString() and param.countyId != '0'.toString()">
            COUNTY_ID countyId,
            COUNTY_NAME countyName,
        </if>
        <if test="param.cityId != '0'.toString() and param.countyId != '0'.toString() and param.gridId != '0'.toString()">
            GRID_ID gridId,
            GRID_NAME gridName,
        </if>
        <choose>
            <when test=" param.cityId == '0'.toString() or param.countyId == '0'.toString() or param.gridId == '0'.toString() ">
                AVG (CUSTOMER_NUM) AS customerNum ,
                SUM( CONTACT_NUM) AS contactNum,
                CASE WHEN AVG(CUSTOMER_NUM) = 0 THEN '0' ELSE (ROUND(SUM(CONTACT_NUM)*100.0/AVG(CUSTOMER_NUM),2)) END AS contactRate,
                SUM( MARKET_SUCCESS_NUM) AS marketSuccessNum,
                CASE WHEN SUM(CONTACT_NUM) = 0 THEN '0' ELSE (ROUND(SUM(MARKET_SUCCESS_NUM)*100.0/SUM(CONTACT_NUM),2)) END AS marketSuccessRate ,
            </when>
            <otherwise>
                CUSTOMER_NUM customerNum,
                CONTACT_NUM contactNum,
                ROUND(CONTACT_RATE,2) contactRate,
                MARKET_SUCCESS_NUM marketSuccessNum,
                ROUND(MARKET_SUCCESS_RATE,2) marketSuccessRate,
            </otherwise>
        </choose>
        CONTACT_TYPE contactType,
        CONTACT_MODE contactMode,
        CHANNEL_ID channelId,
        CHANNEL_NAME channelName
--         ,DATA_DATE dataDate
        FROM smart_grid_effect_eval_default egeede
        WHERE 1 = 1
        <if test="param.startDate != null and param.startDate != '' and param.endDate != null and param.endDate != ''   ">
            and egeede.START_DATE between str_to_date(#{param.startDate },'%Y%m%d%H%i%s') and str_to_date(#{param.endDate },'%Y%m%d%H%i%s')
            <!--and egeede.START_DATE between #{param.startDate} and #{param.endDate}-->
        </if>
        <if test=" param.cityId != '0'.toString() and  param.cityId != '-1'.toString() ">
            AND CITY_ID = #{param.cityId}
        </if>
        <if test=" param.countyId != '0'.toString() and  param.countyId != '-1'.toString() ">
            AND COUNTY_ID = #{param.countyId}
        </if>
        <if test=" param.gridId != '0'.toString() and  param.gridId != '-1'.toString() ">
            AND GRID_ID = #{param.gridId}
        </if>
        <if test=" param.contactType != null and  param.contactType != '' ">
            AND CONTACT_TYPE = #{param.contactType}
        </if>
        <if test=" param.contactMode != null and  param.contactMode != '' ">
            AND CONTACT_MODE = #{param.contactMode}
        </if>
        <if test=" param.keyWordsCamp != null and param.keyWordsCamp != '' ">
            AND (CAMPSEG_PID like concat('%',#{param.keyWordsCamp},'%') or CAMPSEG_NAME like concat('%',#{param.keyWordsCamp},'%'))
        </if>
        <if test=" param.keyWordsPlan != null and param.keyWordsPlan != '' ">
            AND (PLAN_ID like concat('%',#{param.keyWordsPlan},'%') or PLAN_NAME like concat('%',#{param.keyWordsPlan},'%'))
        </if>
        <if test="param.cityId == '0'.toString() or param.countyId == '0'.toString() or param.gridId == '0'.toString()">
            GROUP BY
            CAMPSEG_NAME,CAMPSEG_PID,PLAN_NAME,PLAN_ID,START_DATE,END_DATE
            <if test=" param.cityId != '0'.toString() ">
                ,CITY_ID,
                CITY_NAME
            </if>
            <if test=" param.cityId != '0'.toString() and param.countyId != '0'.toString() ">
                ,COUNTY_ID,
                COUNTY_NAME
            </if>
            <if test=" param.cityId != '0'.toString() and param.countyId != '0'.toString() and param.gridId != '0'.toString() ">
                ,GRID_ID,
                GRID_NAME
            </if>
        </if>
        ORDER BY START_DATE DESC, CAMPSEG_PID DESC
    </select>

    <select id="querySmartGridEffectDay" parameterType="com.asiainfo.biapp.pec.eval.jx.req.SmartGridEvalReq" resultType="com.asiainfo.biapp.pec.eval.jx.vo.SmartGridEvalVo">

        SELECT
        CAMPSEG_NAME campsegName,
        CAMPSEG_PID campsegRootId,
        PLAN_NAME planName,
        PLAN_ID planId,
        START_DATE startDate,
        END_DATE endDate,
        <if test="param.cityId != '0'.toString()">
            CITY_ID cityId ,
            CITY_NAME cityName,
        </if>
        <if test="param.cityId != '0'.toString() and param.countyId != '0'.toString()">
            COUNTY_ID countyId,
            COUNTY_NAME countyName,
        </if>
        <if test="param.cityId != '0'.toString() and param.countyId != '0'.toString() and param.gridId != '0'.toString()">
            GRID_ID gridId,
            GRID_NAME gridName,
        </if>
        <choose>
            <when test=" param.cityId == '0'.toString() or param.countyId == '0'.toString() or param.gridId == '0'.toString() ">
                AVG (CUSTOMER_NUM) AS customerNum ,
                SUM( CONTACT_NUM) AS contactNum,
                CASE WHEN AVG(CUSTOMER_NUM) = 0 THEN '0' ELSE (ROUND(SUM(CONTACT_NUM)*100.0/AVG(CUSTOMER_NUM),2)) END AS contactRate,
                SUM( MARKET_SUCCESS_NUM) AS marketSuccessNum,
                CASE WHEN SUM(CONTACT_NUM) = 0 THEN '0' ELSE (ROUND(SUM(MARKET_SUCCESS_NUM)*100.0/SUM(CONTACT_NUM),2)) END AS marketSuccessRate ,
            </when>
            <otherwise>
                CUSTOMER_NUM customerNum,
                CONTACT_NUM contactNum,
                ROUND(CONTACT_RATE,2) contactRate,
                MARKET_SUCCESS_NUM marketSuccessNum,
                ROUND(MARKET_SUCCESS_RATE,2) marketSuccessRate,
            </otherwise>
        </choose>
        CONTACT_TYPE contactType,
        CONTACT_MODE contactMode,
        CHANNEL_ID channelId,
        CHANNEL_NAME channelName,
        DATA_DATE dataDate
        FROM SMART_GRID_EFFECT_EVAL_DAY sgeeda
        WHERE 1 = 1
        AND DATA_DATE  &gt;= str_to_date(#{param.startDate },'%Y%m%d%H%i%s')
        AND DATA_DATE &lt;= str_to_date(#{param.endDate },'%Y%m%d%H%i%s')
        <if test=" param.cityId != '0'.toString() and  param.cityId != '-1'.toString() ">
            AND CITY_ID = #{param.cityId}
        </if>
        <if test=" param.countyId != '0'.toString() and  param.countyId != '-1'.toString() ">
            AND COUNTY_ID = #{param.countyId}
        </if>
        <if test=" param.gridId != '0'.toString() and  param.gridId != '-1'.toString() ">
            AND GRID_ID = #{param.gridId}
        </if>
        <if test=" param.contactType != null and  param.contactType != '' ">
            AND CONTACT_TYPE = #{param.contactType}
        </if>
        <if test=" param.contactMode != null and  param.contactMode != '' ">
            AND CONTACT_MODE = #{param.contactMode}
        </if>
        <if test=" param.keyWordsCamp != null and param.keyWordsCamp != '' ">
            AND (CAMPSEG_PID like concat('%',#{param.keyWordsCamp},'%') or CAMPSEG_NAME like concat('%',#{param.keyWordsCamp},'%'))
        </if>
        <if test=" param.keyWordsPlan != null and param.keyWordsPlan != '' ">
            AND (PLAN_ID like concat('%',#{param.keyWordsPlan},'%') or PLAN_NAME like concat('%',#{param.keyWordsPlan},'%'))
        </if>
        <if test="param.cityId == '0'.toString() or param.countyId == '0'.toString() or param.gridId == '0'.toString()">
            GROUP BY
            CAMPSEG_NAME,CAMPSEG_PID,PLAN_NAME,PLAN_ID,START_DATE,END_DATE,DATA_DATE
            <if test=" param.cityId != '0'.toString() ">
                ,CITY_ID,
                CITY_NAME
            </if>
            <if test=" param.cityId != '0'.toString() and param.countyId != '0'.toString() ">
                ,COUNTY_ID,
                COUNTY_NAME
            </if>
            <if test=" param.cityId != '0'.toString() and param.countyId != '0'.toString() and param.gridId != '0'.toString() ">
                ,GRID_ID,
                GRID_NAME
            </if>
        </if>
        ORDER BY START_DATE DESC, CAMPSEG_PID DESC
    </select>

    <select id="querySmartGridEffectMonth" parameterType="com.asiainfo.biapp.pec.eval.jx.req.SmartGridEvalReq" resultType="com.asiainfo.biapp.pec.eval.jx.vo.SmartGridEvalVo">

        SELECT
        CAMPSEG_NAME campsegName,
        CAMPSEG_PID campsegRootId,
        PLAN_NAME planName,
        PLAN_ID planId,
        START_DATE startDate,
        END_DATE endDate,
        <if test="param.cityId != '0'.toString()">
            CITY_ID cityId ,
            CITY_NAME cityName,
        </if>
        <if test="param.cityId != '0'.toString() and param.countyId != '0'.toString()">
            COUNTY_ID countyId,
            COUNTY_NAME countyName,
        </if>
        <if test="param.cityId != '0'.toString() and param.countyId != '0'.toString() and param.gridId != '0'.toString()">
            GRID_ID gridId,
            GRID_NAME gridName,
        </if>
        <choose>
            <when test=" param.cityId == '0'.toString() or param.countyId == '0'.toString() or param.gridId == '0'.toString() ">
                AVG (CUSTOMER_NUM) AS customerNum ,
                SUM( CONTACT_NUM) AS contactNum,
                CASE WHEN AVG(CUSTOMER_NUM) = 0 THEN '0' ELSE (ROUND(SUM(CONTACT_NUM)*100.0/AVG(CUSTOMER_NUM),2)) END AS contactRate,
                SUM( MARKET_SUCCESS_NUM) AS marketSuccessNum,
                CASE WHEN SUM(CONTACT_NUM) = 0 THEN '0' ELSE (ROUND(SUM(MARKET_SUCCESS_NUM)*100.0/SUM(CONTACT_NUM),2)) END AS marketSuccessRate ,
            </when>
            <otherwise>
                CUSTOMER_NUM customerNum,
                CONTACT_NUM contactNum,
                ROUND(CONTACT_RATE,2) contactRate,
                MARKET_SUCCESS_NUM marketSuccessNum,
                ROUND(MARKET_SUCCESS_RATE,2) marketSuccessRate,
            </otherwise>
        </choose>
        CONTACT_TYPE contactType,
        CONTACT_MODE contactMode,
        CHANNEL_ID channelId,
        CHANNEL_NAME channelName,
        DATA_DATE dataDate
        FROM smart_grid_effect_eval_month sgeem
        WHERE 1 = 1
        AND DATA_DATE  &gt;= str_to_date(#{param.startDate },'%Y%m%d%H%i%s')
        AND DATA_DATE &lt;= str_to_date(#{param.endDate },'%Y%m%d%H%i%s')
        <if test=" param.cityId != '0'.toString() and  param.cityId != '-1'.toString() ">
            AND CITY_ID = #{param.cityId}
        </if>
        <if test=" param.countyId != '0'.toString() and  param.countyId != '-1'.toString() ">
            AND COUNTY_ID = #{param.countyId}
        </if>
        <if test=" param.gridId != '0'.toString() and  param.gridId != '-1'.toString() ">
            AND GRID_ID = #{param.gridId}
        </if>
        <if test=" param.contactType != null and  param.contactType != '' ">
            AND CONTACT_TYPE = #{param.contactType}
        </if>
        <if test=" param.contactMode != null and  param.contactMode != '' ">
            AND CONTACT_MODE = #{param.contactMode}
        </if>
        <if test=" param.keyWordsCamp != null and param.keyWordsCamp != '' ">
            AND (CAMPSEG_PID like concat('%',#{param.keyWordsCamp},'%') or CAMPSEG_NAME like concat('%',#{param.keyWordsCamp},'%'))
        </if>
        <if test=" param.keyWordsPlan != null and param.keyWordsPlan != '' ">
            AND (PLAN_ID like concat('%',#{param.keyWordsPlan},'%') or PLAN_NAME like concat('%',#{param.keyWordsPlan},'%'))
        </if>
        <if test="param.cityId == '0'.toString() or param.countyId == '0'.toString() or param.gridId == '0'.toString()">
            GROUP BY
            CAMPSEG_NAME,CAMPSEG_PID,PLAN_NAME,PLAN_ID,START_DATE,END_DATE,DATA_DATE
            <if test=" param.cityId != '0'.toString() ">
                ,CITY_ID,
                CITY_NAME
            </if>
            <if test=" param.cityId != '0'.toString() and param.countyId != '0'.toString() ">
                ,COUNTY_ID,
                COUNTY_NAME
            </if>
            <if test=" param.cityId != '0'.toString() and param.countyId != '0'.toString() and param.gridId != '0'.toString() ">
                ,GRID_ID,
                GRID_NAME
            </if>
        </if>
        ORDER BY START_DATE DESC, CAMPSEG_PID DESC
    </select>

</mapper>
