<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.asiainfo.biapp.pec.eval.jx.dao.TdEvalMapper">

    <select id="getTdEvalList" resultType="Map" parameterType="com.asiainfo.biapp.pec.eval.jx.req.TdEvalReq">
       SELECT A.STAT_DATE,
       A.ORG_ID,
       C.CITY_NAME,
       D.COUNTY_NAME,
       SUM(A.CAMP_USER_NUM)                                     CAMP_USER_NUM,
       SUM(A.CAMP_SUCC_NUM)                                     CAMP_SUCC_NUM,
       CASE  WHEN SUM(A.CAMP_USER_NUM) = 0 THEN 0
       ELSE SUM(A.CAMP_SUCC_NUM) / SUM(A.CAMP_USER_NUM) END CAMP_SUCC_RATE,
       B.CHANNEL_NAME                                           ORG_NAME
       FROM
        <if test = "dateType == 'day' || dateType == 'week'">
            MTL_EVAL_INFO_CHN_ORG_D
        </if>
        <if test = "dateType == 'month'">
            MTL_EVAL_INFO_CHN_ORG_M
        </if>
        A
         INNER JOIN DW_CHNL_DEPT B ON B.CHANNEL_ID = A.ORG_ID
         LEFT JOIN mcd_sys_city C ON A.CITY_ID = C.CITY_ID
         LEFT JOIN DIM_PUB_COUNTY D ON A.COUNTY_ID = D.COUNTY_ID
        where 1=1
        <if test = "startDate != null and startDate !=''">
            and A.STAT_DATE &gt;= #{startDate}
        </if>
        <if test = "endDate != null and endDate !=''">
            and A.STAT_DATE &lt;= #{endDate}
        </if>
        <if test="cityId != null and cityId != '' and cityId != '-1'" >
            AND A.CITY_ID = #{cityId}
        </if>
        <if test="countyId != null and countyId != '' and countyId != '-1'" >
            AND A.COUNTY_ID = #{countyId}
        </if>
        <if test="channelId != null and channelId != '' and channelId != '-1'">
            AND A.channel_id = #{channelId}
        </if>
        <if test="keyWords != null and keyWords != ''">
            AND (A.org_id like concat('%',#{keyWords},'%') or B.CHANNEL_NAME like concat('%',#{keyWords},'%'))
        </if>
        GROUP BY A.STAT_DATE, A.ORG_ID, B.CHANNEL_NAME, C.CITY_NAME, D.COUNTY_NAME
        ORDER BY CASE WHEN SUM(A.CAMP_USER_NUM) = 0 THEN 0 ELSE SUM(A.CAMP_SUCC_NUM) / SUM(A.CAMP_USER_NUM) END DESC,
        SUM(A.CAMP_SUCC_NUM) DESC
        limit ${pageStart}, ${pageSize}
    </select>

    <select id="getExportTdEvalList" resultType="Map" parameterType="com.asiainfo.biapp.pec.eval.jx.req.TdEvalReq">
        SELECT A.STAT_DATE,
        A.ORG_ID,
        C.CITY_NAME,
        D.COUNTY_NAME,
        SUM(A.CAMP_USER_NUM)                                     CAMP_USER_NUM,
        SUM(A.CAMP_SUCC_NUM)                                     CAMP_SUCC_NUM,
        CASE  WHEN SUM(A.CAMP_USER_NUM) = 0 THEN 0
        ELSE SUM(A.CAMP_SUCC_NUM) / SUM(A.CAMP_USER_NUM) END CAMP_SUCC_RATE,
        B.CHANNEL_NAME                                           ORG_NAME
        FROM
        <if test = "dateType == 'day' || dateType == 'week'">
            MTL_EVAL_INFO_CHN_ORG_D
        </if>
        <if test = "dateType == 'month'">
            MTL_EVAL_INFO_CHN_ORG_M
        </if>
        A
        INNER JOIN DW_CHNL_DEPT B ON B.CHANNEL_ID = A.ORG_ID
        LEFT JOIN mcd_sys_city C ON A.CITY_ID = C.CITY_ID
        LEFT JOIN DIM_PUB_COUNTY D ON A.COUNTY_ID = D.COUNTY_ID
        where 1=1
        <if test = "startDate != null and startDate !=''">
            and A.STAT_DATE &gt;= #{startDate}
        </if>
        <if test = "endDate != null and endDate !=''">
            and A.STAT_DATE &lt;= #{endDate}
        </if>
        <if test="cityId != null and cityId != '' and cityId != '-1'" >
            AND A.CITY_ID = #{cityId}
        </if>
        <if test="countyId != null and countyId != '' and countyId != '-1'" >
            AND A.COUNTY_ID = #{countyId}
        </if>
        <if test="channelId != null and channelId != '' and channelId != '-1'">
            AND A.channel_id = #{channelId}
        </if>
        <if test="keyWords != null and keyWords != ''">
            AND (A.org_id like concat('%',#{keyWords},'%') or B.CHANNEL_NAME like concat('%',#{keyWords},'%'))
        </if>
        GROUP BY A.STAT_DATE, A.ORG_ID, B.CHANNEL_NAME, C.CITY_NAME, D.COUNTY_NAME
        ORDER BY CASE WHEN SUM(A.CAMP_USER_NUM) = 0 THEN 0 ELSE SUM(A.CAMP_SUCC_NUM) / SUM(A.CAMP_USER_NUM) END DESC,
        SUM(A.CAMP_SUCC_NUM) DESC
    </select>

    <select id="getTdEvalListCount" parameterType="com.asiainfo.biapp.pec.eval.jx.req.TdEvalReq" resultType="java.lang.Integer">
        SELECT count(1) FROM (
            SELECT A.STAT_DATE,
            A.ORG_ID,
            C.CITY_NAME,
            D.COUNTY_NAME,
            SUM(A.CAMP_USER_NUM)                                     CAMP_USER_NUM,
            SUM(A.CAMP_SUCC_NUM)                                     CAMP_SUCC_NUM,
            CASE  WHEN SUM(A.CAMP_USER_NUM) = 0 THEN 0
            ELSE SUM(A.CAMP_SUCC_NUM) / SUM(A.CAMP_USER_NUM) END CAMP_SUCC_RATE,
            B.CHANNEL_NAME                                           ORG_NAME
            FROM
            <if test = "dateType == 'day' || dateType == 'week'">
                MTL_EVAL_INFO_CHN_ORG_D
            </if>
            <if test = "dateType == 'month'">
                MTL_EVAL_INFO_CHN_ORG_M
            </if>
            A
            INNER JOIN DW_CHNL_DEPT B ON B.CHANNEL_ID = A.ORG_ID
            LEFT JOIN mcd_sys_city C ON A.CITY_ID = C.CITY_ID
            LEFT JOIN DIM_PUB_COUNTY D ON A.COUNTY_ID = D.COUNTY_ID
            where 1=1
            <if test = "startDate != null and startDate !=''">
                and A.STAT_DATE &gt;= #{startDate}
            </if>
            <if test = "endDate != null and endDate !=''">
                and A.STAT_DATE &lt;= #{endDate}
            </if>
            <if test="cityId != null and cityId != '' and cityId != '-1'" >
                AND A.CITY_ID = #{cityId}
            </if>
            <if test="countyId != null and countyId != '' and countyId != '-1'" >
                AND A.COUNTY_ID = #{countyId}
            </if>
            <if test="channelId != null and channelId != '' and channelId != '-1'">
                AND A.channel_id = #{channelId}
            </if>
            <if test="keyWords != null and keyWords != ''">
                AND A.org_id like concat('%',#{keyWords},'%')
            </if>
            GROUP BY A.STAT_DATE, A.ORG_ID, B.CHANNEL_NAME, C.CITY_NAME, D.COUNTY_NAME
            ORDER BY CASE WHEN SUM(A.CAMP_USER_NUM) = 0 THEN 0 ELSE SUM(A.CAMP_SUCC_NUM) / SUM(A.CAMP_USER_NUM) END DESC,
            SUM(A.CAMP_SUCC_NUM) DESC
        ) total
    </select>

</mapper>
